<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Send_notification</name>
        <label>Send notification</label>
        <locationX>1131</locationX>
        <locationY>354</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <stringValue>{!curCourse.Sub_Type__c}  course booking confirmation</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <elementReference>finalBody</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailAddressesArray</name>
            <value>
                <elementReference>emailList</elementReference>
            </value>
        </inputParameters>
    </actionCalls>
    <assignments>
        <name>Add_distinct_venue_id</name>
        <label>Add distinct venue id</label>
        <locationX>640</locationX>
        <locationY>656</locationY>
        <assignmentItems>
            <assignToReference>venueIdsDistinct</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>session.Venue__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Session_Loop</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>add_email_to_collection</name>
        <label>add email to collection</label>
        <locationX>614</locationX>
        <locationY>37</locationY>
        <assignmentItems>
            <assignToReference>emailList</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>emailAddress</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>getCourse</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_Session_Line</name>
        <label>Add Session Line</label>
        <locationX>789</locationX>
        <locationY>955</locationY>
        <assignmentItems>
            <assignToReference>sessionText</assignToReference>
            <operator>Add</operator>
            <value>
                <stringValue>Session {!index}:    {!session.Session_Info_For_Flow__c} {!lineBreak}</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Doest_list_contain_this_id</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_Venue_Id</name>
        <label>Add Venue Id</label>
        <locationX>448</locationX>
        <locationY>955</locationY>
        <assignmentItems>
            <assignToReference>index</assignToReference>
            <operator>Add</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Session_Line</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_venues</name>
        <label>Add venues</label>
        <locationX>1290</locationX>
        <locationY>767</locationY>
        <assignmentItems>
            <assignToReference>venueText</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>venueRecord.Venue_Info_For_Flow__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>For_every_venue_id</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>assign_baby_massgae</name>
        <label>assign baby massgae</label>
        <locationX>660</locationX>
        <locationY>386</locationY>
        <assignmentItems>
            <assignToReference>includesBabyMassage</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>get_main_venue</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_Reunion</name>
        <label>Set Reunion</label>
        <locationX>50</locationX>
        <locationY>778</locationY>
        <assignmentItems>
            <assignToReference>includesReunion</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>True</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Is_reunion_provisional_session</targetReference>
        </connector>
    </assignments>
    <constants>
        <name>COURSE_CANCELLED_OR_CANCELLING</name>
        <dataType>String</dataType>
        <value>
            <stringValue>Course is</stringValue>
        </value>
    </constants>
    <constants>
        <name>COURSE_CONFIRMED</name>
        <dataType>String</dataType>
        <value>
            <stringValue>Course is</stringValue>
        </value>
    </constants>
    <decisions>
        <name>Doest_list_contain_this_id</name>
        <label>Doest list contain this id?</label>
        <locationX>781</locationX>
        <locationY>756</locationY>
        <defaultConnector>
            <targetReference>Add_distinct_venue_id</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>True</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>venueIdsDistinct</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <elementReference>session.Venue__c</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Session_Loop</targetReference>
            </connector>
            <label>True</label>
        </rules>
    </decisions>
    <decisions>
        <name>Is_reunion_provisional_session</name>
        <label>Is reunion provisional session?</label>
        <locationX>269</locationX>
        <locationY>773</locationY>
        <defaultConnector>
            <targetReference>Add_Venue_Id</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>true2</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>session.Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Reunion</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>session.Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Provisional</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Session_Loop</targetReference>
            </connector>
            <label>true</label>
        </rules>
    </decisions>
    <decisions>
        <name>IsBabyMassage</name>
        <label>IsBabyMassage</label>
        <locationX>815</locationX>
        <locationY>364</locationY>
        <defaultConnector>
            <targetReference>get_main_venue</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>true4</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>curCourse.Sub_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Baby Massage</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>assign_baby_massgae</targetReference>
            </connector>
            <label>true</label>
        </rules>
    </decisions>
    <decisions>
        <name>IsReunion</name>
        <label>IsReunion</label>
        <locationX>139</locationX>
        <locationY>648</locationY>
        <defaultConnector>
            <targetReference>Is_reunion_provisional_session</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>true1</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>session.Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Reunion</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_Reunion</targetReference>
            </connector>
            <label>true</label>
        </rules>
    </decisions>
    <formulas>
        <name>babyMassageFormula</name>
        <dataType>String</dataType>
        <expression>IF({!includesBabyMassage}, {!babyMassageText}, &#39;&#39; )</expression>
    </formulas>
    <formulas>
        <name>finalBody</name>
        <dataType>String</dataType>
        <expression>SUBSTITUTE(SUBSTITUTE({!emailBody}, &quot;@!$&quot;, &quot;&quot;), &quot;&lt;br&gt;&quot;, &quot;&quot;)</expression>
    </formulas>
    <formulas>
        <name>postcodeURL</name>
        <dataType>String</dataType>
        <expression>SUBSTITUTE({!mainVenue.Postcode__c}, &#39; &#39;, &#39;%20&#39;)</expression>
    </formulas>
    <formulas>
        <name>reunionFormula</name>
        <dataType>String</dataType>
        <expression>IF({!includesReunion}, {!reunionSessionText}, &#39;&#39;)</expression>
    </formulas>
    <formulas>
        <name>venueFinal</name>
        <dataType>String</dataType>
        <expression>SUBSTITUTE({!mainVenue.Venue_Info_For_Flow__c}, &#39;&lt;br&gt;&#39;, {!lineBreak})</expression>
    </formulas>
    <interviewLabel>BookingConfirmationNotificationSend {!$Flow.CurrentDateTime}</interviewLabel>
    <label>BookingConfirmationNotificationSend</label>
    <loops>
        <name>For_every_venue_id</name>
        <label>For every venue id</label>
        <locationX>721</locationX>
        <locationY>556</locationY>
        <assignNextValueToReference>venueId</assignNextValueToReference>
        <collectionReference>venueIdsDistinct</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Get_Venues</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Send_notification</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Session_Loop</name>
        <label>Session Loop</label>
        <locationX>447</locationX>
        <locationY>656</locationY>
        <assignNextValueToReference>session</assignNextValueToReference>
        <collectionReference>sessions</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>IsReunion</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>For_every_venue_id</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_Main_Practitioner</name>
        <label>Get Main Practitioner</label>
        <locationX>261</locationX>
        <locationY>343</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Sessions</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>mainPractitionerId</elementReference>
            </value>
        </filters>
        <object>Contact</object>
        <outputReference>practitionerRecord</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>FirstName</queriedFields>
        <queriedFields>LastName</queriedFields>
        <queriedFields>MobilePhone</queriedFields>
    </recordLookups>
    <recordLookups>
        <name>get_main_venue</name>
        <label>get main venue</label>
        <locationX>577</locationX>
        <locationY>192</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>getBranch</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>curCourse.Main_Venue__c</elementReference>
            </value>
        </filters>
        <object>Venue__c</object>
        <outputReference>mainVenue</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Venue_Info_For_Flow__c</queriedFields>
        <queriedFields>Postcode__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <name>Get_Sessions</name>
        <label>Get Sessions</label>
        <locationX>262</locationX>
        <locationY>505</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Session_Loop</targetReference>
        </connector>
        <filters>
            <field>Course__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>curCourse.Id</elementReference>
            </value>
        </filters>
        <object>Session__c</object>
        <outputReference>sessions</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Venue__c</queriedFields>
        <queriedFields>Session_Info_For_Flow__c</queriedFields>
        <queriedFields>Type__c</queriedFields>
        <queriedFields>Status__c</queriedFields>
        <sortField>Date__c</sortField>
        <sortOrder>Asc</sortOrder>
    </recordLookups>
    <recordLookups>
        <name>Get_Venues</name>
        <label>Get Venues</label>
        <locationX>1056</locationX>
        <locationY>545</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Add_venues</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>venueId</elementReference>
            </value>
        </filters>
        <object>Venue__c</object>
        <outputReference>venueRecord</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Venue_Info_For_Flow__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <name>getBranch</name>
        <label>getBranch</label>
        <locationX>384</locationX>
        <locationY>343</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Main_Practitioner</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>curCourse.Branch__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Account</object>
        <queriedFields>Id</queriedFields>
        <queriedFields>Enquiries_PSA_Email__c</queriedFields>
        <queriedFields>Enquiries_PSA_Phone__c</queriedFields>
        <queriedFields>Enquiries_PSA__c</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getCourse</name>
        <label>getCourse</label>
        <locationX>902</locationX>
        <locationY>214</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>IsBabyMassage</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>courseId</elementReference>
            </value>
        </filters>
        <object>Course__c</object>
        <outputReference>curCourse</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>PSA_Area__c</queriedFields>
        <queriedFields>Name</queriedFields>
        <queriedFields>Sub_Type__c</queriedFields>
        <queriedFields>Branch__c</queriedFields>
        <queriedFields>Main_Venue__c</queriedFields>
    </recordLookups>
    <start>
        <locationX>446</locationX>
        <locationY>37</locationY>
        <connector>
            <targetReference>add_email_to_collection</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <textTemplates>
        <name>babyMassageText</name>
        <text>What you need to know about your course
    · We recommend that your baby has had their 6-8 week medical check up before the course begins. If this appointment is delayed please let us know. Please bring your own massage oil with you to the course, so that you can choose the product most suitable for you and your baby.
    · If you or your baby have any mobility issues, allergies or special requirements please tell us.</text>
    </textTemplates>
    <textTemplates>
        <name>emailBody</name>
        <text>Booking reference: {!curCourse.PSA_Area__c} / {!bookingName}
Course reference: {!curCourse.PSA_Area__c} / {!curCourse.Name}

Dear {!bookingFirstName} {!bookingUtilityField}

Thank you for your payments for this NCT {!curCourse.Sub_Type__c} course:

The course will be facilitated by {!practitionerRecord.FirstName} {!practitionerRecord.LastName} at:

{!venueFinal}
Click here to see this on a map: https://www.google.co.uk/maps?q={!postcodeURL}.

Your complete course dates are as follows:

Day Date Starts Ends Session notes
{!sessionText}

{!reunionFormula}

{!babyMassageFormula}

Contact details
Please do check through the course details carefully. If you’re no longer able to attend the course and wish to discuss other options available, please do contact me as soon as you can.

If you’re unable to attend a particular session or are going to arrive late, please contact the practitioner on {!practitionerRecord.MobilePhone}.

If we can provide you with any further information about our services or help in any other way please do not hesitate to contact me on {!getBranch.Enquiries_PSA_Phone__c}.

In the meantime…
Have you signed up for our free Pregnancy and Baby weekly newsletter? Crammed with evidence-based information from our experts, it gives you the week-by-week support you need. Sign-up today and we look forward to seeing you soon. And finally…don’t forget you can join the UK’s largest community of parents here.

Kind Regards,
{!enquiryName}
Course organiser
{!getBranch.Enquiries_PSA_Phone__c}</text>
    </textTemplates>
    <textTemplates>
        <name>lineBreak</name>
        <text>@!$
@!$</text>
    </textTemplates>
    <textTemplates>
        <name>reunionSessionText</name>
        <text>Course Reunion
There will also be a 2 hour reunion session to meet up again with all your course mates after you have had your babies. Your NCT Practitioner will agree a date, time and location for this with you.</text>
    </textTemplates>
    <variables>
        <name>Booking_Message</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>bookingFirstName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>bookingId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>bookingName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>bookingUtilityField</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>courseId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>curCourse</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Course__c</objectType>
    </variables>
    <variables>
        <name>emailAddress</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>emailList</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>enquiryName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>includesBabyMassage</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <booleanValue>false</booleanValue>
        </value>
    </variables>
    <variables>
        <name>includesReunion</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <booleanValue>false</booleanValue>
        </value>
    </variables>
    <variables>
        <name>index</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>mainPractitionerId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>mainVenue</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Venue__c</objectType>
    </variables>
    <variables>
        <name>practitionerRecord</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Contact</objectType>
    </variables>
    <variables>
        <name>session</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Session__c</objectType>
    </variables>
    <variables>
        <name>sessionDate</name>
        <dataType>Date</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>sessionEnd</name>
        <dataType>DateTime</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>sessions</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Session__c</objectType>
    </variables>
    <variables>
        <name>sessionStart</name>
        <dataType>DateTime</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>sessionText</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>venueId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>venueIdsDistinct</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>venueRecord</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Venue__c</objectType>
    </variables>
    <variables>
        <name>venueText</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
